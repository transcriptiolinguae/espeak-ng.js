import initESpeak from"./espeak-ng.js";function normalizeCurlyApostrophes(e){return e.replace(/[’‘]/g,"'")}const outputElem=document.getElementById("output"),inputElem=document.getElementById("input");let wasmReady=!1;function printErrFiltered(e){e.includes("still waiting on run dependencies")||e.includes("dependency: wasm-instantiate")||e.includes("(end of list)")||console.error("eSpeak stderr:",e)}async function runESpeak(e){let t="";return await initESpeak({arguments:["-v","it","--ipa=3",e],print:e=>{t+=e},printErr:printErrFiltered}),t.replace(/[\u0300-\u036F\u200B-\u200D\uFEFF]/g,"").replace(/rɾ/g,"rː").replace(/mm/g,"mː").replace(/ff/g,"fː").replace(/vv/g,"vː").replace(/ll/g,"lː").replace(/kk/g,"kː").replace(/nn/g,"nː").replace(/ɲɲ/g,"ɲː").replace(/oo/g,"oː").replace(/ss/g,"sː").replace(/tt/g,"t").replace(/dd/g,"d").replace(/ɾ/g,"r").replace(/ɪ/g,"i").replace(/ʊ/g,"u").replace(/ɡ/g,"g").trim()}function showPlaceholder(){outputElem.className="placeholder",outputElem.innerText="Trascrizione"}function showProgressPlaceholder(){outputElem.className="placeholder",outputElem.innerText="Trascrizione in corso..."}function setOutput(e){outputElem.classList.remove("placeholder"),outputElem.innerText=e}function splitTextByLength(e,t=500){const i=[];let n=0;for(;n<e.length;){let s=n+t;if(s<e.length){const t=e.lastIndexOf(" ",s);t>n&&(s=t)}i.push(e.slice(n,s)),n=s}return i}function applyG2PMapping(e,t){const i=[];let n=0,s=0;const u=e.toLowerCase(),o={bb:"bː",dd:"dː",ff:"fː",ll:"lː",mm:"mː",nn:"nː",pp:"pː",qq:"qq",rr:"rː",ss:"sː",tt:"tː",vv:"vː"};for(;s<e.length&&n<t.length;){const c=e[s];let r=t[n];if("d"===r&&"z"===t[n+1]&&"ː"===t[n+2]){i.push(`zz(${r}${t[n+1]}ː)`),s+=2,n+=3;continue}if("t"===r&&"s"===t[n+1]&&"ː"===t[n+2]){i.push(`zz(${r}${t[n+1]}ː)`),s+=2,n+=3;continue}if("i"===u[s]&&"ˈ"===t[n]&&"i"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈi)`),s+=1,n+=3;continue}if("a"===u[s]&&"ˈ"===t[n]&&"a"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈa)`),s+=1,n+=3;continue}if("e"===u[s]&&"ˈ"===t[n]&&"e"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈe)`),s+=1,n+=3;continue}if("e"===u[s]&&"ˈ"===t[n]&&"ɛ"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈɛ)`),s+=1,n+=3;continue}if("'"===u[s]&&/[a-z\u00C0-\u017F]/i.test(u[s+1])){const u=/[a-z\u0250-\u02AF\u02B0-\u02FF\u0300-\u036F\u1D00-\u1DBF\uA700-\uA71F]/i;if("ˈ"===t[n]&&u.test(t[n])&&"ː"===t[n+2]){i.push(`${e[s+1]}(ˈ${t[n+1]})`),s+=2,n+=3;continue}}if("'"===u[s]&&/[a-z]/i.test(u[s+1])){const u=/[a-z\u0250-\u02AF\u02B0-\u02FF\u0300-\u036F\u1D00-\u1DBF\uA700-\uA71F]/i;if("ˈ"===t[n]&&u.test(t[n])){i.push(`${e[s+1]}(ˈ${t[n+1]})`),s+=2,n+=2;continue}}if("'"===u[s]&&/[a-z]/i.test(u[s+1])){const u=/[a-z\u0250-\u02AF\u02B0-\u02FF\u0300-\u036F\u1D00-\u1DBF\uA700-\uA71F]/i;if("ˌ"===t[n]&&u.test(t[n])){i.push(`${e[s+1]}(ˌ${t[n+1]})`),s+=2,n+=2;continue}}if("'"===u[s]&&/[a-z\u00C0-\u017F]/i.test(u[s+1])){if(/[a-z\u0250-\u02AF\u02B0-\u02FF\u0300-\u036F\u1D00-\u1DBF\uA700-\uA71F]/i.test(t[n])){i.push(`'${e[s+1]}(${t[n]})`),s+=2,n+=1;continue}}if("o"===u[s]&&"ˈ"===t[n]&&"o"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈo)`),s+=1,n+=3;continue}if("o"===u[s]&&"ˈ"===t[n]&&"ɔ"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈɔ)`),s+=1,n+=3;continue}if("u"===u[s]&&"ˈ"===t[n]&&"u"===t[n+1]&&"ː"===t[n+2]){i.push(`${e[s]}(ˈu)`),s+=1,n+=3;continue}if("z"===u[s]&&"t"===t[n]&&"s"===t[n+1]){const e=t.slice(n+2,n+4);if(!/ː/.test(e)){i.push(`${c}(ts)`),s+=1,n+=2;continue}}if("z"===u[s]&&"d"===t[n]&&"z"===t[n+1]){const e=t.slice(n+2,n+4);if(!/ː/.test(e)){i.push(`${c}(dz)`),s+=1,n+=2;continue}}if("k"===r&&"ː"===t[n+1]&&"ˈ"===t[n+2]&&"i"===t[n+3]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"i"===t[n+2]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"ˈ"===t[n+2]&&"j"===t[n+3]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"j"===t[n+2]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"ˈ"===t[n+2]&&"e"===t[n+3]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"e"===t[n+2]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"ˈ"===t[n+2]&&"ɛ"===t[n+3]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("k"===r&&"ː"===t[n+1]&&"ɛ"===t[n+2]){i.push(`cch(${r}${t[n+1]})`),s+=3,n+=2;continue}if("g"===u[s]&&"n"===u[s+1]&&"ɲ"===t[n]){const u=t.slice(n+1,n+3);if(!/ː/.test(u)){i.push(`${c}${e[s+1]}(ɲ)`),s+=2,n+=1;continue}}if("g"===u[s]&&"n"===u[s+1]&&"ɲ"===t[n]&&"ː"===t[n+1]){i.push(`${c}${e[s+1]}(ɲː)`),s+=2,n+=2;continue}if("g"===u[s]&&"l"===u[s+1]&&"i"===u[s+2]&&"ʎ"===t[n]){const u=t.slice(n+1,n+3);if(/i|ˈi/.test(u)){i.push(`${c}${e[s+1]}(ʎ)`),s+=2,n+=1;continue}if(!/i|ˈi/.test(u)){i.push(`${c}${e[s+1]}${e[s+2]}(ʎ)`),s+=3,n+=1;continue}}if("t"===r&&"s"===u[s+1]){i.push(`z(${r}${t[n+1]})`),s+=1,n+=2;continue}if("c"===u[s]&&"c"===u[s+1]&&"i"===u[s+2]&&"t"===t[n]&&"ʃ"===t[n+1]&&"ː"===t[n+2]){const u=t.slice(n+3,n+5);if(/ɔ|ˈɔ|o|ˈo|a|ˈa|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}${e[s+2]}(tʃː)`),s+=3,n+=3;continue}}if("g"===u[s]&&"g"===u[s+1]&&"i"===u[s+2]&&"d"===t[n]&&"ʒ"===t[n+1]&&"ː"===t[n+2]){const u=t.slice(n+3,n+5);if(!/i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}${e[s+2]}(dʒː)`),s+=3,n+=3;continue}}if("s"===u[s]&&"c"===u[s+1]&&"i"===u[s+2]&&"ʃ"===t[n]){const u=t.slice(n+1,n+3);if(!/i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}${e[s+2]}(ʃ)`),s+=3,n+=1;continue}}if("c"===u[s]&&"c"===u[s+1]&&"t"===t[n]&&"ʃ"===t[n+1]&&"ː"===t[n+2]){const u=t.slice(n+3,n+5);if(/e|ˈe|ɛ|ˈɛ|i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}(tʃː)`),s+=2,n+=3;continue}}if("g"===u[s]&&"g"===u[s+1]&&"d"===t[n]&&"ʒ"===t[n+1]&&"ː"===t[n+2]){const u=t.slice(n+3,n+5);if(/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}(dʒː)`),s+=2,n+=3;continue}}if("s"===u[s]&&"c"===u[s+1]&&"i"===u[s+2]&&"ʃ"===t[n]){const u=t.slice(n+1,n+3);if(/i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}(ʃ)`),s+=2,n+=1;continue}}if("c"===u[s]&&"i"===u[s+1]&&"t"===t[n]&&"ʃ"===t[n+1]){const u=t.slice(n+2,n+4);if(!/i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}(tʃ)`),s+=2,n+=2;continue}}if("c"===u[s]&&"h"===u[s+1]&&"k"===t[n]){const u=t.slice(n+1,n+3);if(/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}(k)`),s+=2,n+=1;continue}}if("g"===u[s]&&"i"===u[s+1]&&"d"===t[n]&&"ʒ"===t[n+1]){const u=t.slice(n+2,n+4);if(!/i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}(dʒ)`),s+=2,n+=2;continue}}if("g"===u[s]&&"h"===u[s+1]&&"g"===t[n]){const u=t.slice(n+1,n+3);if(/e|ˈe|ɛ|ˈɛ|i|ˈi|j|ˈj/.test(u)){i.push(`${c}${e[s+1]}(g)`),s+=2,n+=1;continue}}if("h"===u[s]&&"a"===u[s+1]&&"ˈ"===t[n]&&"a"===t[n+1]){i.push(`${c}${e[s+1]}(ˈa)`),s+=2,n+=2;continue}if("h"===u[s]&&"a"===u[s+1]&&"ˌ"===t[n]&&"a"===t[n+1]){i.push(`${c}${e[s+1]}(ˌa)`),s+=2,n+=2;continue}if("h"===u[s]&&"o"===u[s+1]&&"ˈ"===t[n]&&"o"===t[n+1]){i.push(`${c}${e[s+1]}(ˈo)`),s+=2,n+=2;continue}if("h"===u[s]&&"a"===u[s+1]&&"a"===t[n]){i.push(`${c}${e[s+1]}(a)`),s+=2,n+=1;continue}if("h"===u[s]&&"ɔ"===u[s+1]&&"ˈ"===t[n]&&"ɔ"===t[n+1]){i.push(`${c}${e[s+1]}(ˈɔ)`),s+=2,n+=2;continue}if("'"===u[s]&&"a"===u[s+1]&&"a"===t[n]){i.push(`${c}${e[s+1]}(a)`),s+=2,n+=1;continue}if("'"===u[s]&&"e"===u[s+1]&&"e"===t[n]){i.push(`${c}${e[s+1]}(e)`),s+=2,n+=1;continue}if("'"===u[s]&&"e"===u[s+1]&&"ɛ"===t[n]){i.push(`${c}${e[s+1]}(ɛ)`),s+=2,n+=1;continue}if("'"===u[s]&&"o"===u[s+1]&&"ɔ"===t[n]){i.push(`${c}${e[s+1]}(ɔ)`),s+=2,n+=1;continue}if("'"===u[s]&&"i"===u[s+1]&&"i"===t[n]){i.push(`${c}${e[s+1]}(i)`),s+=2,n+=1;continue}if("'"===u[s]&&"u"===u[s+1]&&"u"===t[n]){i.push(`${c}${e[s+1]}(u)`),s+=2,n+=1;continue}if("'"===u[s]&&"a"===u[s+1]&&"ˈ"===t[n]&&"a"===t[n+1]){i.push(`${c}${e[s+1]}(ˈa)`),s+=2,n+=2;continue}if("'"===u[s]&&"e"===u[s+1]&&"ˈ"===t[n]&&"e"===t[n+1]){i.push(`${c}${e[s+1]}(ˈe)`),s+=2,n+=2;continue}if("'"===u[s]&&"e"===u[s+1]&&"ˈ"===t[n]&&"ɛ"===t[n+1]){i.push(`${c}${e[s+1]}(ˈɛ)`),s+=2,n+=2;continue}if("'"===u[s]&&"o"===u[s+1]&&"ˈ"===t[n]&&"ɔ"===t[n+1]){i.push(`${c}${e[s+1]}(ˈɔ)`),s+=2,n+=2;continue}if("'"===u[s]&&"i"===u[s+1]&&"ˈ"===t[n]&&"i"===t[n+1]){i.push(`${c}${e[s+1]}(ˈi)`),s+=2,n+=2;continue}if("'"===u[s]&&"u"===u[s+1]&&"ˈ"===t[n]&&"u"===t[n+1]){i.push(`${c}${e[s+1]}(ˈu)`),s+=2,n+=2;continue}if("c"===u[s]&&"t"===t[n]&&"ʃ"===t[n+1]){const e=t.slice(n+2,n+4);if(/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(e)){i.push(`${c}(tʃ)`),s+=1,n+=2;continue}}if("g"===u[s]&&"d"===t[n]&&"ʒ"===t[n+1]){const e=t.slice(n+2,n+4);if(/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(e)){i.push(`${c}(dʒ)`),s+=1,n+=2;continue}}if("s"===u[s]&&"c"===u[s+1]&&"ʃ"===t[n]){const u=t.slice(n+1,n+3);if(/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}(ʃ)`),s+=2,n+=1;continue}}if("c"===u[s]&&"c"===u[s+1]&&"k"===t[n]&&"ː"===t[n+1]){const u=t.slice(n+2,n+4);if(!/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}(kː)`),s+=2,n+=2;continue}}if("c"===u[s]&&"q"===u[s+1]&&"k"===t[n]&&"ː"===t[n+1]){i.push(`${c}${e[s+1]}(kː)`),s+=2,n+=2;continue}if("g"===u[s]&&"g"===u[s+1]&&"d"===t[n]&&"ʒ"===t[n+1]&&"ː"===t[n+2]){const u=t.slice(n+3,n+5);if(!/i|ˈi|j|ˈj|e|ˈe|ɛ|ˈɛ/.test(u)){i.push(`${c}${e[s+1]}(gː)`),s+=2,n+=3;continue}}if("g"===u[s]&&"g"===u[s+1]&&"g"===t[n]&&"ː"===t[n+1]){i.push(`${c}${e[s+1]}(gː)`),s+=2,n+=2;continue}const p=o[u.slice(s,s+2)];p?(i.push(`${e.slice(s,s+2)}(${p})`),s+=2,n+=p.length):("ˈ"===r||"ˌ"===r?(n++,r=t[n],i.push(`${c}(ˈ${r})`)):i.push(`${c}(${r})`),n++,s++)}for(;s<e.length;)i.push(`${e[s]}()`),s++;return i.join("")}window.addEventListener("load",(async()=>{try{await initESpeak({print:()=>{},printErr:()=>{}}),wasmReady=!0,console.log("eSpeak NG WASM loaded and ready")}catch(e){console.error("Error loading WASM:",e),outputElem.classList.remove("placeholder"),outputElem.innerText="Error loading eSpeak WASM module."}})),document.getElementById("convert").addEventListener("click",(async()=>{if(showProgressPlaceholder(),!wasmReady)return void alert("Please wait, WASM is still loading...");const e=inputElem.value.trim();if(e)try{const t=splitTextByLength(e,500);let i="";for(const e of t){const t=e.match(/[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*|[0-9]+(?:[.,][0-9]+)?|[^\s]/gu);if(!t){i+=e;continue}const n=t.filter((e=>/^[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*$/u.test(e))),s=n.join("|"),u=await runESpeak(s),o=u.replace(/\|/g," ").trim().split(/\s+/),c=new Map;for(let e=0;e<n.length;e++)c.set(n[e],o[e]||"");let r="",p=0;for(const i of t){for(;e[p]&&/\s/.test(e[p]);)r+=e[p++];r+=/^[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*$/u.test(i)&&c.get(i)||i,p+=i.length}i+=r}setOutput(i.trim()||"[No output generated]")}catch(e){console.error("Error during AFI transcription:",e),setOutput("Error during AFI transcription: "+e.message)}else showPlaceholder()})),document.getElementById("convertInline").addEventListener("click",(async()=>{if(showProgressPlaceholder(),!wasmReady)return void alert("Please wait, WASM is still loading...");const e=inputElem.value.trim();if(e)try{const t=splitTextByLength(e.replace(/[’‘]/g,"'"),500);let i="",n=0;for(const s of t){const t=s.match(/[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*|[0-9]+(?:[.,][0-9]+)?|[^\s]/gu);if(!t){i+=s;continue}const u=t.filter((e=>/^[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*$/u.test(e))),o=u.join("|"),c=await runESpeak(o),r=c.replace(/\|/g," ").trim().split(/\s+/),p=new Map;for(let e=0;e<u.length;e++)p.set(u[e],r[e]||"");let l="",a=0;for(const e of t){for(;s[a]&&/\s/.test(s[a]);)l+=s[a++];const t=s.slice(a,a+e.length);if(a+=e.length,/^[\p{L}\p{M}]+(?:'[\p{L}\p{M}]+)*$/u.test(e)){const i=p.get(e)||"";l+=`${t}${i?" ("+i+")":""}`}else l+=t}for(;e[n]&&/\s/.test(e[n]);)l=e[n++]+l;n+=s.length,i+=l}setOutput(i)}catch(e){console.error("Error during IPA conversion:",e),setOutput("Error during IPA conversion: "+e.message)}else showPlaceholder()})),document.getElementById("g2p").addEventListener("click",(async()=>{if(showProgressPlaceholder(),!wasmReady)return void alert("Please wait, WASM is still loading...");const e=normalizeCurlyApostrophes(inputElem.value.trim());if(e)try{const t=splitTextByLength(e,500);let i="";for(const e of t){const t=e.match(/[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]+(?:'[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]+)*|[0-9]+(?:[.,][0-9]+)?|[^\s]/gu);if(!t){i+=e;continue}const n=[...new Set(t.filter((e=>/^[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]+'?[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]*$/u.test(e))))],s=n.join("|"),u=await runESpeak(s),o=u.replace(/\|/g," ").trim().split(/\s+/),c=new Map;for(let e=0;e<n.length;e++)c.set(n[e],o[e]||"");const r=t.map((e=>{if(/^[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]+'?[A-Za-zÀ-ÖØ-öø-ÿĀ-žḀ-ỿ]*$/u.test(e)){return applyG2PMapping(e,c.get(e)||"")}return e}));let p="",l=0;for(const i of t){for(;e[l]&&/\s/.test(e[l]);)p+=e[l++];p+=r.shift(),l+=i.length}i+=p}setOutput(i.trim())}catch(e){console.error("Error during G2P processing:",e),setOutput("Error during G2P processing: "+e.message)}else showPlaceholder()}));
