<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G2P Mapping Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 10px 20px;
    }
    #output {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>G2P Mapping Tool</h1>

  <label for="input">Original Text:</label><br />
  <textarea id="input" placeholder="Enter text here..."></textarea><br />

  <button id="convert">Convert to IPA</button>
  <button id="g2p">G2P</button>

  <div id="output">Output will appear here...</div>

  <script>
    const inputElem = document.getElementById('input');
    const outputElem = document.getElementById('output');

    let wasmReady = true; // Simulate WASM ready
    function showPlaceholder() {
      outputElem.textContent = 'Processing...';
    }

    function setOutput(text) {
      outputElem.textContent = text;
    }

    // Dummy runESpeak function - Replace this with real eSpeak integration
    async function runESpeak(text) {
      // Simulate IPA output for demo purposes
      if (text.toLowerCase().includes('ciao')) {
        return 'tʃˈao';
      }
      return '[Simulated IPA output]';
    }

    // G2P Button Handler
    document.getElementById('g2p').addEventListener('click', async () => {
      showPlaceholder();

      const originalText = inputElem.value.trim();
      if (!originalText) {
        setOutput('[Please enter some text]');
        return;
      }

      // Replace spaces with pipes to simulate eSpeak handling
      const markedInput = originalText.replace(/\s+/g, '|');

      let ipa;
      try {
        ipa = await runESpeak(markedInput);
      } catch (e) {
        setOutput('Error during transcription: ' + e.message);
        return;
      }

      // Apply basic G2P mapping based on rule
      let g2pOutput = '';
      const lowerText = originalText.toLowerCase();
      const lowerIpa = ipa.toLowerCase();

      if (lowerText.startsWith('ci') || lowerText.startsWith('c')) {
        const cIndex = lowerText.indexOf('c');
        const iAfterC = lowerText[cIndex + 1] === 'i';
        const iAfterTʃ = lowerIpa[lowerIpa.indexOf('tʃ') + 2] === 'i';

        if (iAfterTʃ) {
          g2pOutput = 'C(tʃ)';
        } else if (!iAfterTʃ && iAfterC) {
          g2pOutput = 'Ci(tʃ)';
        } else {
          g2pOutput = 'C(tʃ)';
        }
      }

      // Display results
      const result = `Original: ${originalText}
Testo e AFI: ${originalText} (${ipa})
G2P: ${g2pOutput}`;

      setOutput(result);
    });

    // Convert to IPA Button Handler
    document.getElementById('convert').addEventListener('click', async () => {
      showPlaceholder();

      if (!wasmReady) {
        alert('Please wait, WASM is still loading...');
        return;
      }

      const rawInput = inputElem.value.trim();
      if (!rawInput) {
        showPlaceholder();
        return;
      }

      const markedInput = rawInput.replace(/\s+/g, '|');

      try {
        const ipa = await runESpeak(markedInput);
        setOutput(`${rawInput} (${ipa})`);
      } catch (e) {
        setOutput('Error during transcription: ' + e.message);
      }
    });
  </script>
</body>
</html>
